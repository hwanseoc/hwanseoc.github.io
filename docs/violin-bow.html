<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bow Torque Calculator</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark; }
    code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100 antialiased">
  <div class="max-w-5xl mx-auto px-4 py-8">
    <!-- Header -->
    <header class="flex items-center gap-4 mb-6">
      <div class="w-11 h-11 rounded-xl bg-gradient-to-tr from-sky-500 to-emerald-400 shadow-[0_8px_30px_rgba(56,189,248,0.35)]"></div>
      <div>
        <h1 class="text-2xl font-semibold tracking-tight">Bow Torque Calculator</h1>
        <p class="text-sm text-slate-400">Computes optimal F₁, F₄, and T that minimize F₁+F₄+T subject to balance constraints.</p>
      </div>
    </header>

    <!-- Card -->
    <section class="rounded-2xl border border-white/10 bg-white/5 p-5 shadow-xl">
      <!-- Inputs grid: order N, dN, W, dW, dF1, dF4 -->
      <div class="grid grid-cols-12 gap-4 items-end">
        <!-- N with slider + number -->
        <div class="col-span-12 lg:col-span-6">
          <label for="nRange" class="block text-xs text-slate-400 mb-1">N (string normal) [N]</label>
          <div class="flex items-center gap-3">
            <input id="nRange" type="range" min="0" max="2.5" step="0.01" value="0.80" class="w-full" />
            <input id="n" type="number" min="0" max="2.5" step="0.01" value="0.80" class="w-28 px-3 py-2 rounded-lg bg-slate-900 border border-white/10" />
          </div>
        </div>

        <!-- dN with slider + number (cm) -->
        <div class="col-span-12 lg:col-span-6">
          <label for="dnRange" class="block text-xs text-slate-400 mb-1">dN (thumb → string contact) [cm]</label>
          <div class="flex items-center gap-3">
            <input id="dnRange" type="range" min="0" max="80" step="1" value="25" class="w-full" />
            <input id="dn" type="number" min="0" max="80" step="1" value="25" class="w-28 px-3 py-2 rounded-lg bg-slate-900 border border-white/10" />
          </div>
        </div>

        <!-- W -->
        <div class="col-span-12 sm:col-span-6 lg:col-span-3">
          <label for="w" class="block text-xs text-slate-400 mb-1">W (bow weight) [N]</label>
          <input id="w" type="number" step="0.01" min="0" value="0.60" class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-white/10" />
        </div>

        <!-- dW -->
        <div class="col-span-12 sm:col-span-6 lg:col-span-3">
          <label for="dw" class="block text-xs text-slate-400 mb-1">dW (thumb → COM) [cm]</label>
          <input id="dw" type="number" step="1" min="0" value="25" class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-white/10" />
        </div>

        <!-- dF1 -->
        <div class="col-span-12 sm:col-span-6 lg:col-span-3">
          <label for="df1" class="block text-xs text-slate-400 mb-1">dF1 (thumb → index) [cm]</label>
          <input id="df1" type="number" step="1" min="0" value="3" class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-white/10" />
        </div>

        <!-- dF4 -->
        <div class="col-span-12 sm:col-span-6 lg:col-span-3">
          <label for="df4" class="block text-xs text-slate-400 mb-1">dF4 (thumb → little) [cm]</label>
          <input id="df4" type="number" step="1" min="0" value="5" class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-white/10" />
        </div>

        <!-- Region pill -->
        <div class="col-span-12">
          <div class="inline-flex items-center gap-3">
            <span class="text-xs text-slate-400">Region</span>
            <span id="region" class="px-3 py-1 rounded-full border border-white/10 bg-slate-900 text-sm">frog</span>
          </div>
        </div>
      </div>

      <!-- Outputs -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-4">
        <div class="rounded-xl border border-white/10 bg-slate-900 p-4 text-center">
          <h3 class="text-xs text-slate-400 mb-1">F1 (index) [N]</h3>
          <div id="outF1" class="text-2xl font-bold tracking-tight">0.0000</div>
        </div>
        <div class="rounded-xl border border-white/10 bg-slate-900 p-4 text-center">
          <h3 class="text-xs text-slate-400 mb-1">T (thumb) [N]</h3>
          <div id="outT" class="text-2xl font-bold tracking-tight">0.0000</div>
        </div>
        <div class="rounded-xl border border-white/10 bg-slate-900 p-4 text-center">
          <h3 class="text-xs text-slate-400 mb-1">F4 (little) [N]</h3>
          <div id="outF4" class="text-2xl font-bold tracking-tight">0.0000</div>
        </div>
      </div>

      <!-- Equations (plaintext) -->
      <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-3">
        <div class="rounded-xl border border-dashed border-white/10 bg-slate-900 p-4">
          <div class="text-sky-300 mb-2">Model (plaintext)</div>
          <pre class="text-[13px] whitespace-pre-wrap"><code>N + T = W + F1 + F4

dN * N - dW * W - dF1 * F1 + dF4 * F4 = 0</code></pre>
        </div>
        <div class="rounded-xl border border-dashed border-white/10 bg-slate-900 p-4">
          <div class="text-sky-300 mb-2">Algorithm (optimal)</div>
          <pre class="text-[13px] whitespace-pre-wrap"><code>Let K = dW*W - dN*N.
Assume dF1>0 and dF4>0.

F1* = max( 0,
          -K/dF1,
          (dF4*(N - W) - K)/(dF4 + dF1) )
F4* = (K + dF1*F1*)/dF4
T*  = W + F1* + F4* - N</code></pre>
        </div>
      </div>

      <!-- Expanded with numbers and checks -->
      <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-3">
        <div class="rounded-xl border border-dashed border-white/10 bg-slate-900 p-4">
          <div class="text-sky-300 mb-2">Expanded torque</div>
          <pre id="eqExpanded" class="text-[13px] whitespace-pre-wrap"></pre>
        </div>
        <div class="rounded-xl border border-dashed border-white/10 bg-slate-900 p-4">
          <div class="text-sky-300 mb-2">Checks</div>
          <pre id="checks" class="text-[13px] whitespace-pre-wrap"></pre>
        </div>
      </div>

      <p class="mt-3 text-xs text-slate-400">Distances use centimeters. Forces use Newtons. Thumb is the moment reference.</p>
    </section>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);

    // Sync handlers
    $('#nRange').addEventListener('input', (e) => { $('#n').value = e.target.value; compute(); });
    $('#n').addEventListener('input', (e) => { $('#nRange').value = e.target.value; compute(); });

    $('#dnRange').addEventListener('input', (e) => { $('#dn').value = e.target.value; compute(); });
    $('#dn').addEventListener('input', (e) => { $('#dnRange').value = e.target.value; compute(); });

    ['w','dw','df1','df4'].forEach(id => { document.getElementById(id).addEventListener('input', compute); });

    function num(id){ return parseFloat(document.getElementById(id).value || '0'); }
    function regionFor(dn, dw){ return dn < dw ? 'frog' : (dn > dw ? 'tip' : 'balance'); }

    function clampSmall(x, eps=1e-12){ return Math.abs(x) < eps ? 0 : x; }

    function compute(){
      const N   = num('n');
      const W   = num('w');
      const dN  = num('dn');
      const dW  = num('dw');
      let dF1 = num('df1');
      let dF4 = num('df4');

      // Guard: enforce strictly positive lever arms for the formula
      const EPS = 1e-9;
      dF1 = dF1 <= 0 ? EPS : dF1;
      dF4 = dF4 <= 0 ? EPS : dF4;

      // Region
      $('#region').textContent = regionFor(dN, dW);

      // Constants
      const K = dW * W - dN * N;

      // Lower bounds for F1
      const lb0 = 0;
      const lbF4pos = -K / dF1; // ensures F4 >= 0
      const lbTpos  = (dF4 * (N - W) - K) / (dF4 + dF1); // ensures T >= 0

      // Optimal F1
      let F1 = Math.max(lb0, lbF4pos, lbTpos);
      // Derived F4 and T
      let F4 = (K + dF1 * F1) / dF4;
      let T  = W + F1 + F4 - N;

      // Numerical hygiene: clamp tiny negatives
      F1 = Math.max(0, clampSmall(F1));
      F4 = Math.max(0, clampSmall(F4));
      T  = Math.max(0, clampSmall(T));

      // Outputs
      $('#outF1').textContent = F1.toFixed(4);
      $('#outF4').textContent = F4.toFixed(4);
      $('#outT').textContent  = T.toFixed(4);

      // Expanded torque with numbers
      const t1 = (dN*N).toFixed(4);
      const t2 = (dW*W).toFixed(4);
      const t3 = (dF1*F1).toFixed(4);
      const t4 = (dF4*F4).toFixed(4);
      $('#eqExpanded').textContent = `dN * N - dW * W - dF1 * F1 + dF4 * F4 = 0\n` +
        `${dN.toFixed(2)} * ${N.toFixed(2)} - ${dW.toFixed(2)} * ${W.toFixed(2)} - ${dF1.toFixed(2)} * ${F1.toFixed(4)} + ${dF4.toFixed(2)} * ${F4.toFixed(4)} = 0\n` +
        `${t1} - ${t2} - ${t3} + ${t4} = 0`;

      // Checks
      const verticalLeft  = (N + T);
      const verticalRight = (W + F1 + F4);
      const torqueLeft    = (dN*N - dW*W - dF1*F1 + dF4*F4);

      function nearlyEqual(a, b, eps = 1e-6){ return Math.abs(a - b) <= eps; }
      const vertical_ok = nearlyEqual(verticalLeft, verticalRight);
      const torque_ok   = nearlyEqual(torqueLeft, 0);

      $('#checks').textContent = `Vertical: N + T = ${verticalLeft.toFixed(4)}  vs  W + F1 + F4 = ${verticalRight.toFixed(4)}  =>  ${vertical_ok ? 'OK' : 'FAIL'}\n` +
        `Torque: dN*N - dW*W - dF1*F1 + dF4*F4 = ${torqueLeft.toFixed(6)}  =>  ${torque_ok ? 'OK' : 'FAIL'}`;
    }

    // Initial compute
    document.addEventListener('DOMContentLoaded', compute);
  </script>
</body>
</html>
